@using System.Text.Json
@inject IJSRuntime JSRuntime

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–ª–æ–±—É—Å–∞</h5>
        <div>
            <button class="btn btn-sm btn-warning" @onclick="ApplySettingsAsync">‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button class="btn btn-sm btn-success" @onclick="SaveSettingsAsync">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-sm btn-primary" @onclick="LoadSettingsAsync">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <button class="btn btn-sm btn-secondary" @onclick="ResetToDefaults">üîÑ –°–±—Ä–æ—Å</button>
        </div>
    </div>
    <div class="card-body">
        <div class="accordion" id="settingsAccordion">

            <!-- –†–∞–∑–º–µ—Ä—ã -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#sizeSettings">
                        üìê –†–∞–∑–º–µ—Ä—ã
                    </button>
                </h2>
                <div id="sizeSettings" class="accordion-collapse collapse show" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="mb-2">
                            <label class="form-label">–®–∏—Ä–∏–Ω–∞: @Settings.Width px</label>
                            <input type="range" class="form-range" min="400" max="2000" step="50" @bind="Settings.Width" @bind:after="ApplySettingsAsync" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–í—ã—Å–æ—Ç–∞: @Settings.Height px</label>
                            <input type="range" class="form-range" min="300" max="1500" step="50" @bind="Settings.Height" @bind:after="ApplySettingsAsync" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢–æ—á–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pointSettings">
                        üìç –¢–æ—á–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                    </button>
                </h2>
                <div id="pointSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="mb-2">
                            <label class="form-label">–†–∞–∑–º–µ—Ä —Ç–æ—á–∫–∏: @Settings.ParticipantPointSize</label>
                            <input type="range" class="form-range" min="0.1" max="2.0" step="0.1" @bind="Settings.ParticipantPointSize" @bind:after="ApplySettingsAsync" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–û—Ç—Å—Ç—É–ø –æ—Ç –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏: @Settings.ParticipantPointOffset</label>
                            <input type="range" class="form-range" min="0.01" max="0.2" step="0.01" @bind="Settings.ParticipantPointOffset" @bind:after="ApplySettingsAsync" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–¶–≤–µ—Ç —Ç–æ—á–∫–∏</label>
                            <input type="color" class="form-control form-control-color" @bind="Settings.ParticipantPointColor" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–¶–≤–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π —Ç–æ—á–∫–∏</label>
                            <input type="color" class="form-control form-control-color" @bind="Settings.HighlightedPointColor" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- –í—Ä–∞—â–µ–Ω–∏–µ -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#rotationSettings">
                        üîÑ –í—Ä–∞—â–µ–Ω–∏–µ
                    </button>
                </h2>
                <div id="rotationSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="mb-2 form-check">
                            <input type="checkbox" class="form-check-input" id="autoRotate" @bind="Settings.AutoRotate" />
                            <label class="form-check-label" for="autoRotate">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—Ä–∞—â–µ–Ω–∏–µ</label>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è: @Settings.AutoRotateSpeed</label>
                            <input type="range" class="form-range" min="0.1" max="2.0" step="0.1" @bind="Settings.AutoRotateSpeed" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- –û—Å–≤–µ—â–µ–Ω–∏–µ -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#lightSettings">
                        üí° –û—Å–≤–µ—â–µ–Ω–∏–µ
                    </button>
                </h2>
                <div id="lightSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="mb-2">
                            <label class="form-label">–Ø—Ä–∫–æ—Å—Ç—å —Å–æ–ª–Ω—Ü–∞: @Settings.SunLightIntensity</label>
                            <input type="range" class="form-range" min="0.1" max="5.0" step="0.1" @bind="Settings.SunLightIntensity" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–¶–≤–µ—Ç —Å–æ–ª–Ω—Ü–∞</label>
                            <input type="color" class="form-control form-control-color" @bind="Settings.SunLightColor" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–Ø—Ä–∫–æ—Å—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏—è: @Settings.AmbientLightIntensity</label>
                            <input type="range" class="form-range" min="0.1" max="5.0" step="0.1" @bind="Settings.AmbientLightIntensity" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–¶–≤–µ—Ç –æ–∫—Ä—É–∂–µ–Ω–∏—è</label>
                            <input type="color" class="form-control form-control-color" @bind="Settings.AmbientLightColor" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –∏ –æ–±–ª–∞–∫–∞ -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#atmosphereSettings">
                        üå´Ô∏è –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –∏ –æ–±–ª–∞–∫–∞
                    </button>
                </h2>
                <div id="atmosphereSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="mb-2 form-check">
                            <input type="checkbox" class="form-check-input" id="enableAtmosphere" @bind="Settings.EnableAtmosphereGlow" />
                            <label class="form-check-label" for="enableAtmosphere">–í–∫–ª—é—á–∏—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É</label>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–¶–≤–µ—Ç –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã</label>
                            <input type="color" class="form-control form-control-color" @bind="Settings.AtmosphereColor" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã: @Settings.AtmosphereOpacity</label>
                            <input type="range" class="form-range" min="0.0" max="1.0" step="0.05" @bind="Settings.AtmosphereOpacity" />
                        </div>
                        <div class="mb-2 form-check">
                            <input type="checkbox" class="form-check-input" id="enableClouds" @bind="Settings.EnableClouds" />
                            <label class="form-check-label" for="enableClouds">–í–∫–ª—é—á–∏—Ç—å –æ–±–ª–∞–∫–∞</label>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –æ–±–ª–∞–∫–æ–≤: @Settings.CloudsOpacity</label>
                            <input type="range" class="form-range" min="0.0" max="1.0" step="0.05" @bind="Settings.CloudsOpacity" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–°–∫–æ—Ä–æ—Å—Ç—å –æ–±–ª–∞–∫–æ–≤: @Settings.CloudsSpeed</label>
                            <input type="range" class="form-range" min="0.0" max="0.1" step="0.01" @bind="Settings.CloudsSpeed" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–∞–º–µ—Ä–∞ -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#cameraSettings">
                        üì∑ –ö–∞–º–µ—Ä–∞
                    </button>
                </h2>
                <div id="cameraSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="mb-2 form-check">
                            <input type="checkbox" class="form-check-input" id="enableZoom" @bind="Settings.EnableZoom" />
                            <label class="form-check-label" for="enableZoom">–†–∞–∑—Ä–µ—à–∏—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ</label>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ: @Settings.MinZoom</label>
                            <input type="range" class="form-range" min="0.5" max="2.0" step="0.1" @bind="Settings.MinZoom" />
                        </div>
                        <div class="mb-2">
                            <label class="form-label">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ: @Settings.MaxZoom</label>
                            <input type="range" class="form-range" min="2.0" max="10.0" step="0.5" @bind="Settings.MaxZoom" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¶–≤–µ—Ç–∞ -->
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#colorSettings">
                        üé® –¶–≤–µ—Ç–∞
                    </button>
                </h2>
                <div id="colorSettings" class="accordion-collapse collapse" data-bs-parent="#settingsAccordion">
                    <div class="accordion-body">
                        <div class="mb-2">
                            <label class="form-label">–¶–≤–µ—Ç —Ñ–æ–Ω–∞</label>
                            <input type="color" class="form-control form-control-color" @bind="Settings.BackgroundColor" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- JSON Preview -->
        <div class="mt-3">
            <label class="form-label">JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</label>
            <textarea class="form-control font-monospace" rows="8" readonly>@JsonPreview</textarea>
        </div>
    </div>
</div>

@code {
    [Parameter] public string GlobeId { get; set; } = "default";
    [Parameter] public EventCallback<GlobeSettings> OnSettingsChanged { get; set; }

    private GlobeSettings Settings { get; set; } = new();
    private string JsonPreview => JsonSerializer.Serialize(Settings, new JsonSerializerOptions { WriteIndented = true });
    private string ContainerId => $"globe-{GlobeId}";

    protected override void OnInitialized()
    {
        LoadDefaultSettings();
    }

    private void LoadDefaultSettings()
    {
        Settings = new GlobeSettings
        {
            Width = 800,
            Height = 600,
            BackgroundColor = "#000011",
            AtmosphereColor = "#00aaff",
            AtmosphereOpacity = 0.2,
            ParticipantPointSize = 0.2,
            ParticipantPointColor = "#ffff00",
            ParticipantPointOffset = 0.02,
            HighlightedPointColor = "#ff6600",
            AutoRotate = true,
            AutoRotateSpeed = 0.1,
            EnableMouseControls = true,
            EnableZoom = true,
            MinZoom = 0.5,
            MaxZoom = 4.0,
            EnableClouds = true,
            CloudsOpacity = 0.1,
            CloudsSpeed = 0.01,
            EnableAtmosphereGlow = true,
            SunLightIntensity = 3.0,
            SunLightColor = "#ffffff",
            AmbientLightIntensity = 4.0,
            AmbientLightColor = "#404040"
        };
    }

    private async Task ApplySettingsAsync()
    {
        var module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/_content/ZealousMindedPeopleGeo/js/community-globe.js");
        await module.InvokeVoidAsync("updateSettings", ContainerId, Settings);
        await OnSettingsChanged.InvokeAsync(Settings);
    }

    private async Task SaveSettingsAsync()
    {
        await ApplySettingsAsync();
        var json = JsonSerializer.Serialize(Settings, new JsonSerializerOptions { WriteIndented = true });
        var fileName = $"globe-settings-{GlobeId}-{DateTime.Now:yyyyMMdd-HHmmss}.json";

        await JSRuntime.InvokeVoidAsync("eval", $@"
            const blob = new Blob([{JsonSerializer.Serialize(json)}], {{ type: 'application/json' }});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = '{fileName}';
            a.click();
            URL.revokeObjectURL(url);
        ");
    }

    private async Task LoadSettingsAsync()
    {
        await JSRuntime.InvokeVoidAsync("eval", $@"
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {{
                const file = e.target.files[0];
                const text = await file.text();
                DotNet.invokeMethodAsync('ZealousMindedPeopleGeo', 'LoadSettingsFromJson', text);
            }};
            input.click();
        ");
    }

    [JSInvokable]
    public static void LoadSettingsFromJson(string json)
    {
        // –ë—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –∏–∑ JavaScript
    }

    private async Task ResetToDefaults()
    {
        LoadDefaultSettings();
        await ApplySettingsAsync();
        StateHasChanged();
    }
    public class GlobeSettings
    {
        public int Width { get; set; }
        public int Height { get; set; }
        public string BackgroundColor { get; set; } = "#000011";
        public string AtmosphereColor { get; set; } = "#00aaff";
        public double AtmosphereOpacity { get; set; }
        public double ParticipantPointSize { get; set; }
        public string ParticipantPointColor { get; set; } = "#ffff00";
        public double ParticipantPointOffset { get; set; }
        public string HighlightedPointColor { get; set; } = "#ff6600";
        public bool AutoRotate { get; set; }
        public double AutoRotateSpeed { get; set; }
        public bool EnableMouseControls { get; set; }
        public bool EnableZoom { get; set; }
        public double MinZoom { get; set; }
        public double MaxZoom { get; set; }
        public bool EnableClouds { get; set; }
        public double CloudsOpacity { get; set; }
        public double CloudsSpeed { get; set; }
        public bool EnableAtmosphereGlow { get; set; }
        public double SunLightIntensity { get; set; }
        public string SunLightColor { get; set; } = "#ffffff";
        public double AmbientLightIntensity { get; set; }
        public string AmbientLightColor { get; set; } = "#404040";
    }
}

